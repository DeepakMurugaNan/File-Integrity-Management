import os
import sys
import django
import hashlib

# Setup Django environment
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'fim_project.settings')
django.setup()

from dashboard.models import MonitoredDirectory, AuditLog, MalwareSignature
from dashboard.utils import scan_directory_and_check, calculate_file_hash

TEST_DIR = os.path.join(os.getcwd(), 'fim_malware_test')
if not os.path.exists(TEST_DIR):
    os.makedirs(TEST_DIR)

# Clean DB
MonitoredDirectory.objects.filter(path=TEST_DIR).delete()
dir_obj = MonitoredDirectory.objects.create(path=TEST_DIR, active=True)

# 1. Setup "Known Bad" Signature
# Let's say a file with content "X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*" is bad
# But for simplicity, let's just use "MALWARE_TEST_STRING"
BAD_CONTENT = "MALWARE_TEST_STRING"
bad_hash = hashlib.sha256(BAD_CONTENT.encode()).hexdigest()

MalwareSignature.objects.get_or_create(
    name="Test.Malware.EICAR_Sim",
    signature_hash=bad_hash
)

# 2. Create Files
# A. Known Bad Hash File
bad_hash_file = os.path.join(TEST_DIR, "virus.txt")
with open(bad_hash_file, 'w') as f:
    f.write(BAD_CONTENT)

# B. Suspicious Extension
bad_ext_file = os.path.join(TEST_DIR, "innocent_looking.exe")
with open(bad_ext_file, 'w') as f:
    f.write("Some random content")

print("Created test files.")

# 3. Scan
scan_directory_and_check(dir_obj)
print("Scan Complete.")

# 4. Verify Logs
logs = AuditLog.objects.filter(change_type='MALWARE', is_resolved=False)

print(f"Total Malware Alerts: {logs.count()}")

found_hash_alert = False
found_ext_alert = False

for log in logs:
    print(f"ALERT: {log.file_path} - {log.details}")
    if "Known Malware" in log.details and "virus.txt" in log.file_path:
        found_hash_alert = True
    if "Suspicious Extension" in log.details and "innocent_looking.exe" in log.file_path:
        found_ext_alert = True

if found_hash_alert:
    print("SUCCESS: Detected Known Bad Hash.")
else:
    print("FAILURE: Did not detect Known Bad Hash.")

if found_ext_alert:
    print("SUCCESS: Detected Suspicious Extension.")
else:
    print("FAILURE: Did not detect Suspicious Extension.")

# Cleanup
MonitoredDirectory.objects.filter(path=TEST_DIR).delete()
try:
    import shutil
    shutil.rmtree(TEST_DIR)
except:
    pass
print("Test Cleanup Complete.")
